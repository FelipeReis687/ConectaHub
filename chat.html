<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chat ‚Ä¢ ConectaHub</title>
  <link rel="stylesheet" href="../background/chat.css" />
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <a class="menu-item active" href="chat.html">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg>
        <span>Chat</span>
      </a>
      <a class="menu-item" href="mural.html">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3h18v4H3z"/><path d="M3 11h18v10H3z"/></svg>
        <span>Mural</span>
      </a>
      <a class="menu-item" href="game.html">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6.61 10.79L5 21h14l-1.61-10.21"/><path d="M10 12l1-3 2 3 3-3"/></svg>
        <span>Game</span>
      </a>
    </aside>

    <div class="rail"></div>

    <section class="list" aria-label="Lista de contatos">
      <div class="list-header">Chat</div>
      <div class="search-container">
        <input type="text" id="searchInput" class="search-input" placeholder="üîç Pesquisar usu√°rios...">
      </div>
      <div id="contacts" class="contacts">
        <!-- Come√ßa VAZIO ‚Äî nada est√°tico ser√° mostrado -->
      </div>
    </section>

    <main class="chat" aria-label="Janela do chat">
      <div class="chat-header">
        <img id="chatAvatar" src="https://ui-avatars.com/api/?name=Usuario&background=0d3b5a&color=fff" alt="Avatar" />
        <div class="title">
          <span id="chatName" class="name">&nbsp;</span>
          <span class="presence"><span class="dot"></span><span id="presenceText" style="margin-left:6px;"></span></span>
        </div>
      </div>

      <div id="messages" class="messages">
        <!-- Mensagens aparecem aqui ap√≥s selecionar contato -->
      </div>

      <div class="input-bar">
        <div class="plus">+</div>
        <div class="field"><input id="msgInput" type="text" placeholder="" disabled /></div>
        <button class="send" id="sendBtn" aria-label="Enviar" disabled>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 2L11 13"/><path d="M22 2L15 22"/><path d="M2 12l9 1"/></svg>
        </button>
      </div>
    </main>
  </div>

  <div class="debug-info" id="debugInfo" style="display:none">Debug</div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

<!-- Cole ISSO no final do seu chat.html (ou substitua o script atual) -->
<script>
  // ====== CONFIG FIREBASE (j√° com suas credenciais) ======
  const firebaseConfig = {
    apiKey: "AIzaSyC13wSq4nvjZIWW8G7pStco5MKUsxBYiPA",
    authDomain: "conectahub-1f810.firebaseapp.com",
    projectId: "conectahub-1f810",
    storageBucket: "conectahub-1f810.firebasestorage.app",
    messagingSenderId: "1071669291596",
    appId: "1:1071669291596:web:cf8b525e1888fdb2a9e2e9",
    measurementId: "G-MYKYNDG9LR"
  };

  try {
    firebase.initializeApp(firebaseConfig);
    console.log('Firebase inicializado');
  } catch (err) {
    console.error('Erro init firebase', err);
  }

  const auth = firebase.auth();
  const db = firebase.firestore();

  // ====== SELECTORS ======
  const searchInput = document.getElementById('searchInput');
  const contactsContainer = document.getElementById('contacts');
  const messagesContainer = document.getElementById('messages');
  const msgInput = document.getElementById('msgInput');
  const sendBtn = document.getElementById('sendBtn');
  const chatName = document.getElementById('chatName');
  const chatAvatar = document.getElementById('chatAvatar');
  const presenceText = document.getElementById('presenceText');
  const debugInfo = document.getElementById('debugInfo');

  // ====== STATE ======
  let currentUser = null;
  let allUsers = []; // carregados do Firestore
  let selectedContact = null;
  let messagesUnsubscribe = null;

  // ====== Helpers ======
  function updateDebug(message) {
    if (debugInfo) {
      debugInfo.style.display = 'block';
      debugInfo.textContent = message;
    }
    console.log('DEBUG:', message);
  }

  function escapeHtml(str) {
    if (!str) return '';
    return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;');
  }

  function formatTime(date) {
    const hh = String(date.getHours()).padStart(2,'0');
    const mm = String(date.getMinutes()).padStart(2,'0');
    return `${hh}:${mm}`;
  }

  // ====== AUTH CHECK ======
  auth.onAuthStateChanged(async (user) => {
    if (!user) {
      // n√£o autenticado ‚Üí redireciona ao cadastro/login
      console.log('Usuario n√£o autenticado. Redirecionando...');
      window.location.href = 'cadastro.html';
      return;
    }
    currentUser = user;
    console.log('Usu√°rio logado:', currentUser.uid, currentUser.email);
    updateUserStatus(true).catch(e => console.error(e));
    listenUsersRealtime();
  });

  // ====== UPDATE ONLINE STATUS ======
  async function updateUserStatus(isOnline) {
    if (!currentUser) return;
    const docRef = db.collection('users').doc(currentUser.uid);
    return docRef.set({
      uid: currentUser.uid,
      email: currentUser.email,
      displayName: currentUser.displayName || currentUser.email.split('@')[0],
      isOnline: isOnline,
      lastSeen: firebase.firestore.FieldValue.serverTimestamp(),
      avatar: `https://ui-avatars.com/api/?name=${encodeURIComponent(currentUser.displayName || currentUser.email)}&background=0d3b5a&color=fff`
    }, { merge: true });
  }

  // ====== LISTEN USERS (realtime) - render users AUTOMATICALLY ======
  function listenUsersRealtime() {
    console.log('Iniciando listener de users...');
    db.collection('users')
      .onSnapshot(snapshot => {
        const users = [];
        snapshot.forEach(doc => {
          const data = doc.data() || {};
          const uid = data.uid || doc.id;
          // ignore self
          if (uid === currentUser.uid) return;
          users.push(Object.assign({}, data, { uid }));
        });
        // atualiza estado
        allUsers = users;
        updateDebug(`Usu√°rios carregados: ${allUsers.length}`);

        // Se houver texto na busca, aplica filtro; se n√£o, exibe todos
        const term = (searchInput.value || '').trim();
        if (term) {
          performSearchAndRender(term);
        } else {
          renderContacts(allUsers); // <-- agora mostramos todos quando a busca est√° vazia
        }

        // Seleciona automaticamente o primeiro contato (se nenhum estiver selecionado)
        if (!selectedContact && allUsers.length > 0) {
          // selecionar o primeiro usu√°rio automaticamente
          const first = allUsers[0];
          // simular click programaticamente: marca selected no DOM e abre chat
          const firstDiv = contactsContainer.querySelector(`.contact[data-uid="${first.uid}"]`);
          if (firstDiv) {
            // remove sele√ß√£o anterior
            document.querySelectorAll('.contact.selected').forEach(c => c.classList.remove('selected'));
            firstDiv.classList.add('selected');
          }
          openChatWithUser(first);
        }
      }, err => {
        console.error('Erro ao ouvir users', err);
        updateDebug('Erro ao carregar usu√°rios (ver console).');
      });
  }

  // ====== SEARCH & RENDER ======
  function performSearchAndRender(term) {
    const q = term.toLowerCase();
    const filtered = allUsers.filter(u => {
      const name = (u.displayName || (u.email||'').split('@')[0] || '').toLowerCase();
      const mail = (u.email || '').toLowerCase();
      return name.includes(q) || mail.includes(q);
    });

    renderContacts(filtered);
  }

  function renderContacts(users) {
    contactsContainer.innerHTML = ''; // always start empty

    if (!users || users.length === 0) {
      // mostrar nota amig√°vel quando n√£o h√° contatos
      const note = document.createElement('div');
      note.className = 'contacts-empty-note';
      note.textContent = 'Nenhum usu√°rio encontrado.';
      contactsContainer.appendChild(note);
      return;
    }

    users.forEach(u => {
      const name = u.displayName || (u.email? u.email.split('@')[0] : 'Usu√°rio');
      const avatar = u.avatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=0d3b5a&color=fff`;
      const div = document.createElement('div');
      div.className = 'contact';
      div.dataset.uid = u.uid;
      div.dataset.name = name;
      div.dataset.avatar = avatar;
      div.innerHTML = `
        <img src="${avatar}" alt="${escapeHtml(name)}" onerror="this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=0d3b5a&color=fff'"/>
        <div class="meta">
          <span class="name">${escapeHtml(name)}</span>
          <span class="status"><span class="dot" style="background:${u.isOnline? '#2ecc71' : '#e74c3c'}"></span> ${u.isOnline? 'online' : 'offline'}</span>
        </div>
      `;
      div.addEventListener('click', () => {
        // remove .selected from previous
        document.querySelectorAll('.contact.selected').forEach(c => c.classList.remove('selected'));
        div.classList.add('selected');
        openChatWithUser(u);
      });
      contactsContainer.appendChild(div);
    });
  }

  // ====== SEARCH INPUT HANDLER ======
  searchInput.addEventListener('input', (e) => {
    const term = e.target.value.trim();
    if (!term) {
      // mostra todos os usu√°rios quando busca est√° vazia
      renderContacts(allUsers);
      return;
    }
    performSearchAndRender(term);
  });

  // allow Enter to select first result (if any)
  searchInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      const first = contactsContainer.querySelector('.contact');
      if (first) first.click();
    }
  });

  // ====== OPEN CHAT ======
  function openChatWithUser(userObj) {
    if (!userObj || !userObj.uid) return;
    selectedContact = userObj;
    chatName.textContent = userObj.displayName || (userObj.email? userObj.email.split('@')[0] : '');
    chatAvatar.src = userObj.avatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(chatName.textContent)}&background=0d3b5a&color=fff`;
    presenceText.textContent = userObj.isOnline ? 'online' : 'offline';

    // enable input
    msgInput.disabled = false;
    sendBtn.disabled = false;
    msgInput.placeholder = 'Digite uma mensagem...';
    msgInput.focus();

    // load messages (realtime)
    loadMessages(userObj.uid);
  }

  // ====== GENERATE CHAT ID (consistent order) ======
  function generateChatId(a, b) {
    return [a, b].sort().join('_');
  }

  // ====== LOAD MESSAGES (realtime) ======
  function loadMessages(otherUid) {
    if (!currentUser || !otherUid) return;
    const chatId = generateChatId(currentUser.uid, otherUid);

    // remove previous listener
    if (messagesUnsubscribe) {
      try { messagesUnsubscribe(); } catch(e){/*ignore*/ }
      messagesUnsubscribe = null;
    }

    const collRef = db.collection('chats').doc(chatId).collection('messages').orderBy('timestamp', 'asc');

    messagesUnsubscribe = collRef.onSnapshot(snapshot => {
      messagesContainer.innerHTML = ''; // clear
      if (snapshot.empty) {
        // show friendly note when no messages
        const note = document.createElement('div');
        note.className = 'no-messages';
        note.innerHTML = `<p>Nenhuma mensagem ainda. Envie a primeira mensagem!</p>`;
        messagesContainer.appendChild(note);
        return;
      }
      snapshot.forEach(doc => {
        const m = doc.data();
        const div = document.createElement('div');
        const isOwn = m.senderId === currentUser.uid;
        div.className = 'bubble ' + (isOwn ? 'outgoing' : 'incoming');
        const ts = m.timestamp && m.timestamp.toDate ? formatTime(m.timestamp.toDate()) : formatTime(new Date());
        div.innerHTML = `${escapeHtml(m.text)}<span class="time">${ts}</span>`;
        messagesContainer.appendChild(div);
      });
      // scroll to bottom
      setTimeout(() => { messagesContainer.scrollTop = messagesContainer.scrollHeight; }, 120);
    }, err => {
      console.error('Erro ao ouvir mensagens:', err);
      updateDebug('Erro ao carregar mensagens (ver console).');
    });
  }

  // ====== SEND MESSAGE ======
  sendBtn.addEventListener('click', sendMessage);
  msgInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') sendMessage();
  });

  async function sendMessage() {
    const text = (msgInput.value || '').trim();
    if (!text || !selectedContact || !currentUser) return;

    const chatId = generateChatId(currentUser.uid, selectedContact.uid);
    try {
      await db.collection('chats').doc(chatId).collection('messages').add({
        text: text,
        senderId: currentUser.uid,
        senderName: currentUser.displayName || currentUser.email,
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
        read: false
      });
      msgInput.value = '';
      msgInput.focus();
    } catch (err) {
      console.error('Erro ao enviar mensagem', err);
      updateDebug('Erro ao enviar mensagem (ver console).');
    }
  }

  // ====== Cleanup on unload: mark offline ======
  window.addEventListener('beforeunload', async () => {
    try { await updateUserStatus(false); } catch(e){/*ignore*/ }
  });

  // Optional: expose for debugging
  window._conectaHub = { db, auth };
</script>
</body>
</html>
